DROP TABLE IF EXISTS mdl_elp_progress_view;
CREATE VIEW `mdl_elp_progress_view` AS select `mdl_elp_progress_data`.`userid` AS `userid`,`mdl_elp_progress_data`.`courseid` AS `courseid`,sum(`mdl_elp_progress_data`.`course_contribution`) AS `course_total`,substr(min(if(`mdl_elp_progress_data`.`category_passed` = 0,if(`mdl_elp_progress_data`.`category_type` = 'PDV_FIN','3 B) Ungraded','0 F) Failed Category'),if(`mdl_elp_progress_data`.`category_type` = 'PDV_WEB','5 C) In Progress',if(`mdl_elp_progress_data`.`items_taken` < `mdl_elp_progress_data`.`category_items`,'2 C) Category Incomplete',if(`mdl_elp_progress_data`.`items_passed` < `mdl_elp_progress_data`.`category_items`,'1 E) Failed Item',if(`mdl_elp_progress_data`.`category_type` = 'PDV_FIN','4 A) Pass Final','5 C) In Progress')))))),3) AS `overall`,from_unixtime(max(`mdl_elp_progress_data`.`lastdate`)) AS `lastdate`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_FIN',`mdl_elp_progress_data`.`category_percent`,0)) AS `finalassess_mark`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_FIN',`mdl_elp_progress_data`.`course_contribution`,0)) AS `finalassess_part`,max(if(`mdl_elp_progress_data`.`category_type` <> 'PDV_FIN','- Not Started -',if(`mdl_elp_progress_data`.`items_passed` >= `mdl_elp_progress_data`.`category_items`,if(`mdl_elp_progress_data`.`category_passed` >= 1,'Complete','Category failed'),if(`mdl_elp_progress_data`.`items_passed` = `mdl_elp_progress_data`.`items_taken`,concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`),concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' failed ',`mdl_elp_progress_data`.`items_taken` - `mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`))))) AS `finalassess_status`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_ASM',`mdl_elp_progress_data`.`category_percent`,0)) AS `assess_mark`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_ASM',`mdl_elp_progress_data`.`course_contribution`,0)) AS `assess_part`,max(if(`mdl_elp_progress_data`.`category_type` <> 'PDV_ASM','- Not Started -',if(`mdl_elp_progress_data`.`items_passed` >= `mdl_elp_progress_data`.`category_items`,if(`mdl_elp_progress_data`.`category_passed` >= 1,'Complete','Category failed'),if(`mdl_elp_progress_data`.`items_passed` = `mdl_elp_progress_data`.`items_taken`,concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`),concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' failed ',`mdl_elp_progress_data`.`items_taken` - `mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`))))) AS `assess_status`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_ASG',`mdl_elp_progress_data`.`category_percent`,0)) AS `assign_mark`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_ASG',`mdl_elp_progress_data`.`course_contribution`,0)) AS `assign_part`,max(if(`mdl_elp_progress_data`.`category_type` <> 'PDV_ASG','- Not Started -',if(`mdl_elp_progress_data`.`items_passed` >= `mdl_elp_progress_data`.`category_items`,if(`mdl_elp_progress_data`.`category_passed` >= 1,'Complete','Category failed'),if(`mdl_elp_progress_data`.`items_passed` = `mdl_elp_progress_data`.`items_taken`,concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`),concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' failed ',`mdl_elp_progress_data`.`items_taken` - `mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`))))) AS `assign_status`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_WEB',`mdl_elp_progress_data`.`category_percent`,0)) AS `webinar_mark`,sum(if(`mdl_elp_progress_data`.`category_type` = 'PDV_WEB',`mdl_elp_progress_data`.`course_contribution`,0)) AS `webinar_part`,max(if(`mdl_elp_progress_data`.`category_type` <> 'PDV_WEB','- Not Started -',if(`mdl_elp_progress_data`.`items_passed` >= `mdl_elp_progress_data`.`category_items`,'Complete',if(`mdl_elp_progress_data`.`category_passed` >= 2,'Sufficient',if(`mdl_elp_progress_data`.`items_passed` = `mdl_elp_progress_data`.`items_taken`,concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`),concat('Passed ',`mdl_elp_progress_data`.`items_passed`,' failed ',`mdl_elp_progress_data`.`items_taken` - `mdl_elp_progress_data`.`items_passed`,' of ',`mdl_elp_progress_data`.`category_items`)))))) AS `webinar_status` from `mdl_elp_progress_data` group by `mdl_elp_progress_data`.`userid`,`mdl_elp_progress_data`.`courseid`;
