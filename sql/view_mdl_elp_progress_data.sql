DROP TABLE IF EXISTS mdl_elp_progress_data;
CREATE VIEW `mdl_elp_progress_data` AS select `gg`.`userid` AS `userid`,`gi`.`courseid` AS `courseid`,`gc`.`id` AS `categoryid`,`gci`.`idnumber` AS `category_type`,round(sum(100 * `gg`.`finalgrade` / `gi`.`grademax` * `gi`.`aggregationcoef2` * `gci`.`aggregationcoef2`),2) AS `course_contribution`,round(sum(`gg`.`finalgrade`),2) AS `category_raw`,round(sum(`gg`.`finalgrade` / `gi`.`grademax` * `gi`.`aggregationcoef2`) * (select sum(`mdl_grade_items`.`grademax`) from `mdl_grade_items` where `mdl_grade_items`.`categoryid` = `gc`.`id` and `mdl_grade_items`.`gradetype` = 1),2) AS `category_mark`,round(sum(100 * `gg`.`finalgrade` / `gi`.`grademax` * `gi`.`aggregationcoef2`),2) AS `category_percent`,(select count(`mdl_grade_items`.`id`) from `mdl_grade_items` where `mdl_grade_items`.`categoryid` = `gc`.`id` and `mdl_grade_items`.`gradetype` = 1) AS `category_items`,count(`gg`.`id`) AS `items_taken`,sum(if(`gg`.`finalgrade` >= `gi`.`gradepass`,1,0)) AS `items_passed`,if(`gci`.`gradepass` = 0,1,if(round(sum(`gg`.`finalgrade` / `gi`.`grademax` * `gi`.`aggregationcoef2`) * (select sum(`mdl_grade_items`.`grademax`) from `mdl_grade_items` where `mdl_grade_items`.`categoryid` = `gc`.`id` and `mdl_grade_items`.`gradetype` = 1),2) >= `gci`.`gradepass`,2,0)) AS `category_passed`,max(`gg`.`timemodified`) AS `lastdate` from (((`mdl_grade_categories` `gc` join `mdl_grade_items` `gci` on(`gci`.`iteminstance` = `gc`.`id` and `gci`.`itemtype` = 'category')) join `mdl_grade_items` `gi` on(`gc`.`id` = `gi`.`categoryid`)) join `mdl_grade_grades` `gg` on(`gi`.`id` = `gg`.`itemid`)) where `gg`.`finalgrade` is not null and `gci`.`idnumber` regexp '^PDV_...$' and `gi`.`gradetype` = 1 group by `gg`.`userid`,`gi`.`courseid`,`gc`.`id`;